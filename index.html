<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>×˜××¤×¨×˜×•×¨×” ×‘××§×¨×¨×™×</title>
  <style>
    body { font-family: sans-serif; direction: rtl; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    .alarm { background-color: #ffcccc; color: #900; font-weight: bold; }
    .normal { background-color: #ccffcc; color: #060; }
  </style>
</head>
<body>
  <h2>×˜××¤×¨×˜×•×¨×” ×‘××§×¨×¨×™× (1â€“19)</h2>
  <table id="fridgeTable">
    <thead>
      <tr><th>#</th><th>×©×</th><th>×˜××¤×¨×˜×•×¨×”</th><th>×¡×˜×˜×•×¡</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const history = {}; // Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ñ‚ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€

    function isFreezer(name) {
      return name.includes("××§×¤×™×") || name.toLowerCase().includes("freezer");
    }

    function determineStatus(name, temp, id) {
      const now = Date.now();
      const threshold = isFreezer(name) ? -1 : 9;
      const alarm = parseFloat(temp) > threshold;

      if (!history[id]) history[id] = [];
      history[id].push({ time: now, temp: parseFloat(temp), alarm });

      // Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ğ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 60 Ğ¼Ğ¸Ğ½ÑƒÑ‚
      history[id] = history[id].filter(e => now - e.time < 60 * 60 * 1000);

      // ĞµÑĞ»Ğ¸ Ñ‚Ñ€ĞµĞ²Ğ¾Ğ¶Ğ½Ğ¾Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ÑÑ Ğ±Ğ¾Ğ»ĞµĞµ 30 Ğ¼Ğ¸Ğ½ÑƒÑ‚
      const alarmPeriods = history[id].filter(e => e.alarm);
      const firstAlarm = alarmPeriods[0]?.time;
      const longEnough = firstAlarm && (now - firstAlarm > 30 * 60 * 1000);

      return alarm && longEnough ? "alarm" : "normal";
    }

    async function fetchData() {
      const response = await fetch("http://109.67.166.227:82/cgi-bin/cgi.cgi?Status");
      const text = await response.text();
      const parser = new DOMParser();
      const xml = parser.parseFromString(text, "application/xml");

      const table = document.querySelector("#fridgeTable tbody");
      table.innerHTML = "";

      const items = xml.querySelectorAll("u");
      for (let i = 0; i < items.length; i += 6) {
        const id = items[i]?.textContent;
        const name = items[i+1]?.textContent;
        const temp = items[i+2]?.textContent;

        if (!id || parseInt(id) > 19) continue;

        const status = determineStatus(name, temp, id);

        const row = document.createElement("tr");
        row.className = status;
        row.innerHTML = `
          <td>${id}</td>
          <td>${name}</td>
          <td>${temp}</td>
          <td>${status === "alarm" ? "ğŸ”´ Alarm" : "âœ… Normal"}</td>
        `;
        table.appendChild(row);
      }
    }

    fetchData();
    setInterval(fetchData, 60000); // Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 60 ÑĞµĞºÑƒĞ½Ğ´
  </script>
</body>
</html>
