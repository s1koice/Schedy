<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–î–∞—à–±–æ—Ä–¥ ‚Äî –•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#f7f7f7; --card:#fff; --text:#222; --muted:#666; --line:#e6e6e6; --ok:#2e7d32; --warn:#ed6c02; --bad:#c62828; --accent:#1a73e8;}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Arial,Helvetica,sans-serif}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 18px;background:#fff;border-bottom:1px solid var(--line)}
    header h1{font-size:18px;margin:0}
    header nav a{color:var(--accent);text-decoration:none;margin-left:12px}
    .wrap{padding:16px 18px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
    .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 4px 16px rgba(0,0,0,.05)}
    .name{font-weight:700;margin-bottom:4px}
    .temp{font-size:28px;margin:6px 0}
    .meta{font-size:12px;color:var(--muted)}
    .status{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;color:#fff}
    .status.ok{background:var(--ok)} .status.warn{background:var(--warn)} .status.bad{background:var(--bad)}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
    select,input{border:1px solid var(--line);border-radius:8px;padding:6px 9px;font-size:13px}
    .note{color:var(--muted);font-size:12px}
    footer{margin:16px 18px;color:#888;font-size:11px}
  </style>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    /* Firebase Web App config (–∏–∑ —Ç–≤–æ–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞) */
    const firebaseConfig = {
      apiKey: "AIzaSyC6651JMpQhj9FVoqKb_kRndo1r6prZ9kY",
      authDomain: "keen-berm-470615-h6.firebaseapp.com",
      projectId: "keen-berm-470615-h6",
      storageBucket: "keen-berm-470615-h6.firebasestorage.app",
      messagingSenderId: "772648903570",
      appId: "1:772648903570:web:4aa21c0da258c82d52d74b",
      measurementId: "G-7VGNRGC0G7"
    };
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();
    const SITE_ID=(location.hostname||'').replace(/\./g,'-')||'default';
  </script>
</head>
<body>
  <header>
    <h1>–î–∞—à–±–æ—Ä–¥ ‚Äî –•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∏</h1>
    <nav>
      <a href="schedule.html">üìÖ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –≥—Ä–∞—Ñ–∏–∫–∞</a>
    </nav>
  </header>

  <main class="wrap">
    <div class="filters">
      <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:
        <select id="sortSel">
          <option value="name">–ø–æ –∏–º–µ–Ω–∏</option>
          <option value="temp">–ø–æ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ</option>
          <option value="updated">–ø–æ –≤—Ä–µ–º–µ–Ω–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</option>
        </select>
      </label>
      <label>–§–∏–ª—å—Ç—Ä:
        <select id="statusSel">
          <option value="all">–≤—Å–µ</option>
          <option value="ok">ok</option>
          <option value="warn">warn</option>
          <option value="bad">bad</option>
        </select>
      </label>
      <span class="note" id="countNote"></span>
    </div>

    <div class="grid" id="grid"></div>
  </main>

  <footer>
    <span id="releaseInfo">Release: 2025-08-15 00:00 (Asia/Jerusalem)</span>
  </footer>

  <script>
    /* ===== Firestore: —Å–ª—É—à–∞–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é `sites/<siteId>/fridges` –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ `fridges` =====
       –í—ã–±–µ—Ä–∏ –í–ê–†–ò–ê–ù–¢ A –∏–ª–∏ B –Ω–∏–∂–µ –∏ –æ—Å—Ç–∞–≤—å –æ–¥–∏–Ω:
       A) –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è fridges (–ø—Ä–æ—â–µ):
           db.collection('fridges')
       B) –í–ª–æ–∂–µ–Ω–Ω–∞—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–∞–π—Ç–∞:
           db.collection('sites').doc(SITE_ID).collection('fridges')
    */
    const FRIDGES = db.collection('sites').doc(SITE_ID).collection('fridges'); // –í–∞—Ä–∏–∞–Ω—Ç B

    const gridEl=document.getElementById('grid');
    const sortSel=document.getElementById('sortSel');
    const statusSel=document.getElementById('statusSel');
    const countNote=document.getElementById('countNote');

    let fridges=[]; // {id,name,temp,status,updatedAt}

    function render(){
      let list=[...fridges];
      const sf=statusSel.value;
      if(sf!=='all') list=list.filter(x=>x.status===sf);

      const s=sortSel.value;
      if(s==='name') list.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
      if(s==='temp') list.sort((a,b)=>(a.temp??0)-(b.temp??0));
      if(s==='updated') list.sort((a,b)=>(b.updatedAt?.toMillis?.()||0)-(a.updatedAt?.toMillis?.()||0));

      countNote.textContent=`–ø–æ–∫–∞–∑–∞–Ω–æ ${list.length} –∏–∑ ${fridges.length}`;

      gridEl.innerHTML='';
      list.forEach(doc=>{
        const card=document.createElement('div'); card.className='card';
        const name=document.createElement('div'); name.className='name'; name.textContent=doc.name||doc.id;
        const temp=document.createElement('div'); temp.className='temp'; temp.textContent=(doc.temp??'‚Äî')+'¬∞C';
        const st=document.createElement('span'); st.className='status '+(doc.status||'ok'); st.textContent=doc.status||'ok';
        const meta=document.createElement('div'); meta.className='meta';
        const t = doc.updatedAt?.toDate ? doc.updatedAt.toDate() : null;
        meta.textContent='–û–±–Ω–æ–≤–ª–µ–Ω–æ: '+(t? t.toLocaleString('ru-RU') : '‚Äî');
        card.appendChild(name); card.appendChild(temp); card.appendChild(st); card.appendChild(meta);
        gridEl.appendChild(card);
      });
    }

    sortSel.onchange=render; statusSel.onchange=render;

    // Live updates
    FRIDGES.onSnapshot(snap=>{
      fridges = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      render();
    }, err=>{
      alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è Firestore (fridges):\n'+(err.message||err.code||String(err)));
    });
  </script>
</body>
</html>
