<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>סידור עבודה – ראשי</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7f7f7; --card:#fff; --text:#222; --muted:#666; --line:#e6e6e6;
      --accent:#1a73e8;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Arial,Helvetica,sans-serif}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:16px 20px}
    header h1{font-size:20px;margin:0}
    header nav a{color:var(--accent);text-decoration:none}
    .bar{height:1px;background:var(--line)}
    .grid{
      display:flex; gap:16px; padding:20px; overflow-x:auto; -webkit-overflow-scrolling:touch;
    }
    .day-card{
      flex:0 0 320px; background:var(--card); border-radius:12px; padding:14px;
      box-shadow:0 4px 16px rgba(0,0,0,.06); border:1px solid var(--line)
    }
    .day-head{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px}
    .day-head .dow{font-weight:700}
    .day-head .date{color:var(--muted);font-size:14px}
    .section{margin-top:10px}
    .section h3{font-size:14px;margin:0 0 8px 0;color:#333}
    ol{margin:0;padding-inline-start:18px}
    li{padding:2px 0}
    .empty{color:var(--muted);font-style:italic}
    footer{padding:10px 20px 20px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>סידור עבודה</h1>
    <nav><a href="settings.html">הגדרות</a></nav>
  </header>
  <div class="bar"></div>

  <main class="grid" id="daysGrid">
    <!-- כרטיסי ימים נוצרים דינמית -->
  </main>

  <footer>טיפ: העדכונים נעשים בדף <strong>הגדרות</strong> ושמורים בדפדפן (localStorage).</footer>

  <script>
    // שמות ימים קבועים לשבוע ישראלי (מתחיל בראשון)
    const WEEKDAYS = ["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"];

    function loadData(){
      const rawEmployees = localStorage.getItem('employees');
      const rawDates = localStorage.getItem('weekDates');
      let employees = [];
      let weekDates = [];

      try{ employees = rawEmployees ? JSON.parse(rawEmployees) : []; }catch(e){ employees=[]; }
      try{ weekDates = rawDates ? JSON.parse(rawDates) : []; }catch(e){ weekDates=[]; }

      // אם אין תאריכים – נייצר לשבוע הקרוב בפורמט dd.mm.yyyy
      if(!Array.isArray(weekDates) || weekDates.length!==7){
        const now = new Date();
        // מיישרים ליום ראשון של השבוע הנוכחי
        const day = now.getDay(); // 0=Sunday? בדפדפן: 0=Sunday, 6=Saturday
        const delta = (day+7-0)%7;  // כמה ימים אחורה להגיע לראשון
        const sunday = new Date(now); sunday.setDate(now.getDate()-delta);
        weekDates = Array.from({length:7}, (_,i)=>{
          const d = new Date(sunday); d.setDate(sunday.getDate()+i);
          return d.toLocaleDateString('he-IL'); // למשל 15.8.2025
        });
        localStorage.setItem('weekDates', JSON.stringify(weekDates));
      }

      return {employees, weekDates};
    }

    function buildSchedule(employees){
      // בונים מבנה { dayIndex: { morning:[{name,time}], evening:[...] } }
      const sched = Array.from({length:7}, ()=>({morning:[], evening:[]}));
      for(const emp of employees){
        const name = (emp.name||"").trim();
        const shifts = emp.shifts || {};
        for(let i=0;i<7;i++){
          const d = shifts["d"+i] || {};
          if(d.m) sched[i].morning.push({name, time: d.timeM || ""});
          if(d.e) sched[i].evening.push({name, time: d.timeE || ""});
        }
      }
      // מיון אלפביתי בעברית
      for(const day of sched){
        day.morning.sort((a,b)=>a.name.localeCompare(b.name,'he'));
        day.evening.sort((a,b)=>a.name.localeCompare(b.name,'he'));
      }
      return sched;
    }

    function render(){
      const {employees, weekDates} = loadData();
      const schedule = buildSchedule(employees);
      const grid = document.getElementById('daysGrid');
      grid.innerHTML = "";

      for(let i=0;i<7;i++){
        const card = document.createElement('section');
        card.className = "day-card";

        const head = document.createElement('div');
        head.className = "day-head";
        const dow = document.createElement('div');
        dow.className = "dow";
        dow.textContent = WEEKDAYS[i];
        const date = document.createElement('div');
        date.className = "date";
        date.textContent = weekDates[i] || "";
        head.appendChild(dow);
        head.appendChild(date);

        const secMorning = document.createElement('div');
        secMorning.className = "section";
        secMorning.innerHTML = "<h3>בוקר</h3>";

        const mList = schedule[i].morning;
        if(mList.length){
          const ol = document.createElement('ol');
          mList.forEach((p)=> {
            const li = document.createElement('li');
            li.textContent = p.time ? `${p.name} — ${p.time}` : p.name;
            ol.appendChild(li);
          });
          secMorning.appendChild(ol);
        } else {
          const em = document.createElement('div'); em.className="empty"; em.textContent="—";
          secMorning.appendChild(em);
        }

        const secEvening = document.createElement('div');
        secEvening.className = "section";
        secEvening.innerHTML = "<h3>ערב</h3>";

        const eList = schedule[i].evening;
        if(eList.length){
          const ol = document.createElement('ol');
          eList.forEach((p)=> {
            const li = document.createElement('li');
            li.textContent = p.time ? `${p.name} — ${p.time}` : p.name;
            ol.appendChild(li);
          });
          secEvening.appendChild(ol);
        } else {
          const em = document.createElement('div'); em.className="empty"; em.textContent="—";
          secEvening.appendChild(em);
        }

        card.appendChild(head);
        card.appendChild(secMorning);
        card.appendChild(secEvening);
        grid.appendChild(card);
      }
    }

    render();
  </script>
</body>
</html>
