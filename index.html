<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×˜××¤×¨×˜×•×¨×” ×‘××§×¨×¨×™× (1â€“19)</title>
  <style>
    :root { --ok:#0a7b0a; --warn:#b88700; --bad:#b00020; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 16px; }
    h2 { margin: 0 0 8px; }
    .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .pill { padding: 4px 10px; border-radius: 999px; background:#f1f5f9; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #e5e7eb; padding: 10px; text-align: center; }
    th { background: #f8fafc; position: sticky; top: 0; z-index: 1; }
    tr.ok { background: #ecfdf5; }
    tr.alarm { background: #fef2f2; }
    tr.sensor { background: #fff7ed; }
    .tag { font-weight: 600; }
    .tag.ok { color: var(--ok); }
    .tag.alarm { color: var(--bad); }
    .tag.sensor { color: var(--warn); }
    footer { margin-top: 16px; font-size: 12px; color:#64748b; text-align: center; }
  </style>
</head>
<body>
  <h2>×˜××¤×¨×˜×•×¨×” ×‘××§×¨×¨×™× (1â€“19)</h2>
  <div class="controls">
    <span id="lastUpdate" class="pill">â€”</span>
    <span class="pill">×¨×£ ××§×¨×¨: 9Â°Câ†‘ = Alarm</span>
    <span class="pill">×¨×£ ××§×¤×™×: âˆ’1Â°Câ†‘ = Alarm</span>
    <span class="pill">Alarm ×¨×§ ×× > 30 ×“×§'</span>
  </div>

  <table id="fridgeTable" aria-label="Fridge temperatures">
    <thead>
      <tr>
        <th style="width:72px">#</th>
        <th>×©×</th>
        <th style="width:120px">×˜××¤×¨×˜×•×¨×”</th>
        <th style="width:120px">×¡×˜×˜×•×¡</th>
        <th style="width:180px">××©×š ×¢×œ×™×™×” (×“×§×•×ª)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <footer id="release"></footer>

  <script>
  const DATA_URL = "https://fridge-proxy-vercel.vercel.app/api/status";
  const history = {}; // Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ñ‚ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€

  function isFreezer(name) {
    return (name || "").includes("××§×¤×™×") || (name || "").toLowerCase().includes("freezer");
  }

 

    async function fetchData() {
  const resp = await fetch(DATA_URL, { cache: "no-store" });
  const text = await resp.text();
  // Ğ´Ğ°Ğ»ÑŒÑˆĞµ Ñƒ Ñ‚ĞµĞ±Ñ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ render(text) Ğ¸Ğ»Ğ¸ Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³ XML â†’ Ğ¾ÑÑ‚Ğ°Ğ²ÑŒ ĞºĞ°Ğº Ğ±Ñ‹Ğ»Ğ¾
  render(text);
}
        const text = await resp.text();
        // Ğ¸Ñ‰ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°Ğº XML Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸
        if (text.includes("<update") && text.includes('i="list_')) {
          console.log("Using endpoint:", url);
          return { url, text };
        } else {
          console.warn("Endpoint", url, "returned unexpected body");
        }
      } catch (e) {
        console.warn("Endpoint", url, "error:", e.message);
      }
    }
    throw new Error("Ğ’ÑĞµ ĞºĞ°Ğ½Ğ´Ğ¸Ğ´Ğ°Ñ‚Ñ‹ Ğ²ĞµÑ€Ğ½ÑƒĞ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ¸Ğ»Ğ¸ Ğ½ĞµĞ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚");
  }

  function determineStatus(name, temp, id) {
    const now = Date.now();
    const threshold = isFreezer(name) ? -1 : 9;
    const t = parseFloat(temp);
    const alarmNow = Number.isFinite(t) && t > threshold;

    if (!history[id]) history[id] = [];
    history[id].push({ time: now, temp: Number.isFinite(t) ? t : null, alarm: alarmNow });
    // Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼ Ğ´Ğ¾ 60 Ğ¼Ğ¸Ğ½ÑƒÑ‚
    history[id] = history[id].filter(e => now - e.time < 60 * 60 * 1000);

    // ĞºĞ°Ğº Ğ´Ğ¾Ğ»Ğ³Ğ¾ Ğ¿Ğ¾Ğ´Ñ€ÑĞ´ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµĞ½Ğ¸Ğµ
    let minutes = 0;
    for (let i = history[id].length - 1; i >= 0; i--) {
      const e = history[id][i];
      if (!e.alarm) break;
      const prevT = i > 0 ? history[id][i - 1].time : e.time;
      minutes += Math.max(1, Math.round((e.time - prevT) / 60000));
    }

    // Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°: <10 Ğ¼Ğ¸Ğ½ â€” Ğ¸Ğ³Ğ½Ğ¾Ñ€; â‰¥30 Ğ¼Ğ¸Ğ½ â€” Alarm; Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ â€” Normal
    if (minutes >= 30) return { cls: "alarm", label: "ğŸ”´ Alarm" };
    return { cls: "normal", label: minutes > 0 ? "â³ Spike (<10m)" : "âœ… Normal" };
  }

  function render(xmlText) {
    const parser = new DOMParser();
    const xml = parser.parseFromString(xmlText, "application/xml");
    const table = document.querySelector("#fridgeTable tbody");
    table.innerHTML = "";

    const items = xml.querySelectorAll("u");
    for (let i = 0; i < items.length; i += 6) {
      const id = items[i]?.textContent?.trim();
      const name = items[i + 1]?.textContent?.trim();
      const temp = items[i + 2]?.textContent?.trim();

      // Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ 1..19
      const idNum = parseInt(id, 10);
      if (!id || !(idNum >= 1 && idNum <= 19)) continue;

      const st = determineStatus(name, temp, id);

      const row = document.createElement("tr");
      row.className = st.cls;
      row.innerHTML = `
        <td>${id}</td>
        <td>${name ?? "-"}</td>
        <td>${Number.isFinite(parseFloat(temp)) ? parseFloat(temp).toFixed(1) : "â€”"}</td>
        <td>${st.label}</td>
      `;
      table.appendChild(row);
    }
  }

  async function fetchData() {
    const banner = document.querySelector("h2");
    try {
      const { url, text } = await tryCandidates();
      banner.dataset.endpoint = url; // Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ° ĞºĞ°ĞºĞ¾Ğ¹ URL ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»
      render(text);
    } catch (e) {
      console.error(e);
      // Ğ¿Ğ¾ĞºĞ°Ğ¶ĞµĞ¼ Ğ¿Ğ¾Ğ½ÑÑ‚Ğ½ÑƒÑ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ
      const tbody = document.querySelector("#fridgeTable tbody");
      tbody.innerHTML = `<tr><td colspan="4">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ: ${e.message}. ĞÑ‚ĞºÑ€Ğ¾Ğ¹ ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ (F12) â†’ Console, ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸, ĞºĞ°ĞºĞ¸Ğµ URL Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ğ»Ğ¸.</td></tr>`;
    }
  }

  fetchData();
  setInterval(fetchData, 60000);
</script>
</body>
</html>
