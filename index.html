<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>טמפרטורה במקררים (1–19)</title>
  <style>
    :root { --ok:#0a7b0a; --warn:#b88700; --bad:#b00020; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 16px; }
    h2 { margin: 0 0 8px; }
    .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .pill { padding: 4px 10px; border-radius: 999px; background:#f1f5f9; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #e5e7eb; padding: 10px; text-align: center; }
    th { background: #f8fafc; position: sticky; top: 0; z-index: 1; }
    tr.ok { background: #ecfdf5; }
    tr.alarm { background: #fef2f2; }
    tr.sensor { background: #fff7ed; }
    .tag { font-weight: 600; }
    .tag.ok { color: var(--ok); }
    .tag.alarm { color: var(--bad); }
    .tag.sensor { color: var(--warn); }
    footer { margin-top: 16px; font-size: 12px; color:#64748b; text-align: center; }
  </style>
</head>
<body>
  <h2>טמפרטורה במקררים (1–19)</h2>
  <div class="controls">
    <span id="lastUpdate" class="pill">—</span>
    <span class="pill">רף מקרר: 9°C↑ = Alarm</span>
    <span class="pill">רף מקפיא: −1°C↑ = Alarm</span>
    <span class="pill">Alarm רק אם > 30 דק'</span>
  </div>

  <table id="fridgeTable" aria-label="Fridge temperatures">
    <thead>
      <tr>
        <th style="width:72px">#</th>
        <th>שם</th>
        <th style="width:120px">טמפרטורה</th>
        <th style="width:120px">סטטוס</th>
        <th style="width:180px">משך עלייה (דקות)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <footer id="release"></footer>

  <script>
  const DATA_URL = "https://fridge-proxy-vercel.vercel.app/api/status";
  const history = {}; // история температур

  function isFreezer(name) {
    return (name || "").includes("מקפיא") || (name || "").toLowerCase().includes("freezer");
  }

 

    async function fetchData() {
  const resp = await fetch(DATA_URL, { cache: "no-store" });
  const text = await resp.text();
  // дальше у тебя уже есть render(text) или парсинг XML → оставь как было
  render(text);
}
        const text = await resp.text();
        // ищем признак XML с данными
        if (text.includes("<update") && text.includes('i="list_')) {
          console.log("Using endpoint:", url);
          return { url, text };
        } else {
          console.warn("Endpoint", url, "returned unexpected body");
        }
      } catch (e) {
        console.warn("Endpoint", url, "error:", e.message);
      }
    }
    throw new Error("Все кандидаты вернули ошибку или неожиданный ответ");
  }

  function determineStatus(name, temp, id) {
    const now = Date.now();
    const threshold = isFreezer(name) ? -1 : 9;
    const t = parseFloat(temp);
    const alarmNow = Number.isFinite(t) && t > threshold;

    if (!history[id]) history[id] = [];
    history[id].push({ time: now, temp: Number.isFinite(t) ? t : null, alarm: alarmNow });
    // держим до 60 минут
    history[id] = history[id].filter(e => now - e.time < 60 * 60 * 1000);

    // как долго подряд превышение
    let minutes = 0;
    for (let i = history[id].length - 1; i >= 0; i--) {
      const e = history[id][i];
      if (!e.alarm) break;
      const prevT = i > 0 ? history[id][i - 1].time : e.time;
      minutes += Math.max(1, Math.round((e.time - prevT) / 60000));
    }

    // правила: <10 мин — игнор; ≥30 мин — Alarm; остальное — Normal
    if (minutes >= 30) return { cls: "alarm", label: "🔴 Alarm" };
    return { cls: "normal", label: minutes > 0 ? "⏳ Spike (<10m)" : "✅ Normal" };
  }

  function render(xmlText) {
    const parser = new DOMParser();
    const xml = parser.parseFromString(xmlText, "application/xml");
    const table = document.querySelector("#fridgeTable tbody");
    table.innerHTML = "";

    const items = xml.querySelectorAll("u");
    for (let i = 0; i < items.length; i += 6) {
      const id = items[i]?.textContent?.trim();
      const name = items[i + 1]?.textContent?.trim();
      const temp = items[i + 2]?.textContent?.trim();

      // только 1..19
      const idNum = parseInt(id, 10);
      if (!id || !(idNum >= 1 && idNum <= 19)) continue;

      const st = determineStatus(name, temp, id);

      const row = document.createElement("tr");
      row.className = st.cls;
      row.innerHTML = `
        <td>${id}</td>
        <td>${name ?? "-"}</td>
        <td>${Number.isFinite(parseFloat(temp)) ? parseFloat(temp).toFixed(1) : "—"}</td>
        <td>${st.label}</td>
      `;
      table.appendChild(row);
    }
  }

  async function fetchData() {
    const banner = document.querySelector("h2");
    try {
      const { url, text } = await tryCandidates();
      banner.dataset.endpoint = url; // подсказка какой URL сработал
      render(text);
    } catch (e) {
      console.error(e);
      // покажем понятную ошибку на странице
      const tbody = document.querySelector("#fridgeTable tbody");
      tbody.innerHTML = `<tr><td colspan="4">Ошибка обновления: ${e.message}. Открой консоль (F12) → Console, смотри, какие URL пробовали.</td></tr>`;
    }
  }

  fetchData();
  setInterval(fetchData, 60000);
</script>
</body>
</html>
