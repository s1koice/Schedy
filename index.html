<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>טמפרטורה במקררים</title>
  <style>
    body { font-family: sans-serif; direction: rtl; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    .alarm { background-color: #ffcccc; color: #900; font-weight: bold; }
    .normal { background-color: #ccffcc; color: #060; }
  </style>
</head>
<body>
  <h2>טמפרטורה במקררים (1–19)</h2>
  <table id="fridgeTable">
    <thead>
      <tr><th>#</th><th>שם</th><th>טמפרטורה</th><th>סטטוס</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const history = {}; // для хранения истории температур

    function isFreezer(name) {
      return name.includes("מקפיא") || name.toLowerCase().includes("freezer");
    }

    function determineStatus(name, temp, id) {
      const now = Date.now();
      const threshold = isFreezer(name) ? -1 : 9;
      const alarm = parseFloat(temp) > threshold;

      if (!history[id]) history[id] = [];
      history[id].push({ time: now, temp: parseFloat(temp), alarm });

      // оставим только записи за последние 60 минут
      history[id] = history[id].filter(e => now - e.time < 60 * 60 * 1000);

      // если тревожное значение держится более 30 минут
      const alarmPeriods = history[id].filter(e => e.alarm);
      const firstAlarm = alarmPeriods[0]?.time;
      const longEnough = firstAlarm && (now - firstAlarm > 30 * 60 * 1000);

      return alarm && longEnough ? "alarm" : "normal";
    }

    async function fetchData() {
      const response = await fetch("http://109.67.166.227:82/cgi-bin/cgi.cgi?Status");
      const text = await response.text();
      const parser = new DOMParser();
      const xml = parser.parseFromString(text, "application/xml");

      const table = document.querySelector("#fridgeTable tbody");
      table.innerHTML = "";

      const items = xml.querySelectorAll("u");
      for (let i = 0; i < items.length; i += 6) {
        const id = items[i]?.textContent;
        const name = items[i+1]?.textContent;
        const temp = items[i+2]?.textContent;

        if (!id || parseInt(id) > 19) continue;

        const status = determineStatus(name, temp, id);

        const row = document.createElement("tr");
        row.className = status;
        row.innerHTML = `
          <td>${id}</td>
          <td>${name}</td>
          <td>${temp}</td>
          <td>${status === "alarm" ? "🔴 Alarm" : "✅ Normal"}</td>
        `;
        table.appendChild(row);
      }
    }

    fetchData();
    setInterval(fetchData, 60000); // обновление каждые 60 секунд
  </script>
</body>
</html>
