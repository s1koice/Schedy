<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>סידור עבודה – הגדרות</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#fafafa; --card:#fff; --text:#222; --muted:#666; --line:#e6e6e6; --accent:#1a73e8;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Arial,Helvetica,sans-serif}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:16px 20px}
    header h1{font-size:20px;margin:0}
    header nav a{color:var(--accent);text-decoration:none}
    .bar{height:1px;background:var(--line)}
    .wrap{padding:20px;display:flex;flex-direction:column;gap:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.05);padding:14px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .row label{font-size:14px;color:#333}
    input[type="date"], input[type="text"]{
      border:1px solid var(--line);border-radius:8px;padding:8px 10px;font-size:14px
    }
    button{
      border:0;background:var(--accent);color:#fff;border-radius:10px;
      padding:8px 14px;font-size:14px;cursor:pointer
    }
    button.ghost{background:#eef4ff;color:#1a73e8}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--line);padding:8px 6px;font-size:13px;text-align:center}
    th{background:#f2f5ff}
    td.name{min-width:180px;text-align:right}
    .actions{display:flex;gap:8px}
    .note{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>הגדרות</h1>
    <nav><a href="index.html">חזרה לסידור</a></nav>
  </header>
  <div class="bar"></div>

  <main class="wrap">
    <!-- תאריכים לשבוע -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <strong>תאריכים לשבוע (ראשון–שבת):</strong>
          <span class="note">הדפדפן שומר את הנתונים (localStorage)</span>
        </div>
        <div class="actions">
          <button class="ghost" id="btnFillWeek">מילוי אוטומטי לשבוע הקרוב</button>
          <button id="btnSaveDates">שמירת תאריכים</button>
        </div>
      </div>
      <div class="row" id="datesRow" style="margin-top:10px"></div>
    </section>

    <!-- טבלת עובדים -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <strong>עובדים ושיבוץ (בוקר/ערב לכל יום):</strong>
        <div class="actions">
          <button class="ghost" id="btnAdd">הוספת עובד</button>
          <button id="btnSaveAll">שמירה</button>
        </div>
      </div>
      <div class="note" style="margin-top:6px">ליד כל שם – 14 תיבות סימון: שתי תיבות לכל יום (בוקר / ערב). ניתן גם למלא שעת משמרת לצד כל סימון.</div>
      <div style="overflow:auto; margin-top:10px">
        <table id="tbl">
          <thead>
            <tr>
              <th rowspan="2">שם</th>
              <th colspan="2">א׳</th>
              <th colspan="2">ב׳</th>
              <th colspan="2">ג׳</th>
              <th colspan="2">ד׳</th>
              <th colspan="2">ה׳</th>
              <th colspan="2">ו׳</th>
              <th colspan="2">ש׳</th>
              <th rowspan="2">מחיקה</th>
            </tr>
            <tr>
              <!-- לכל יום: בוקר / ערב -->
              <th>בוקר</th><th>ערב</th>
              <th>בוקר</th><th>ערב</th>
              <th>בוקר</th><th>ערב</th>
              <th>בוקר</th><th>ערב</th>
              <th>בוקר</th><th>ערב</th>
              <th>בוקר</th><th>ערב</th>
              <th>בוקר</th><th>ערב</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const WEEKDAYS_SHORT = ["א׳","ב׳","ג׳","ד׳","ה׳","ו׳","ש׳"];

    function qs(s, el=document){ return el.querySelector(s); }
    function ce(tag, props={}){ const el = document.createElement(tag); Object.assign(el, props); return el; }

    // --- תאריכים ---
    function loadDates(){
      try{
        const arr = JSON.parse(localStorage.getItem('weekDates')||"[]");
        if(Array.isArray(arr) && arr.length===7) return arr;
      }catch(e){}
      return Array(7).fill("");
    }
    function saveDates(dates){
      localStorage.setItem('weekDates', JSON.stringify(dates));
      alert("התאריכים נשמרו.");
    }
    function fillNextWeek(){
      const now = new Date();
      const day = now.getDay(); // 0=Sunday
      const delta = (day+7-0)%7;
      const sunday = new Date(now); sunday.setDate(now.getDate()-delta);
      const dates = Array.from({length:7}, (_,i)=>{
        const d=new Date(sunday); d.setDate(sunday.getDate()+i);
        return d.toLocaleDateString('he-IL');
      });
      return dates;
    }
    function renderDates(){
      const row = qs('#datesRow'); row.innerHTML="";
      const stored = loadDates();
      for(let i=0;i<7;i++){
        const wrap = ce('div');
        const label = ce('label'); label.textContent = WEEKDAYS_SHORT[i] + ": ";
        const input = ce('input',{type:'text', value: stored[i]||"", style:"width:120px"});
        input.dataset.idx = i;
        wrap.appendChild(label); wrap.appendChild(input);
        row.appendChild(wrap);
      }
    }

    // --- עובדים ---
    function loadEmployees(){
      try{
        const arr = JSON.parse(localStorage.getItem('employees')||"[]");
        if(Array.isArray(arr)) return arr;
      }catch(e){}
      return [];
    }
    function saveEmployees(list){
      localStorage.setItem('employees', JSON.stringify(list));
      alert("הנתונים נשמרו.");
    }

    function renderTable(){
      const tbody = qs('#tbody'); tbody.innerHTML="";
      const employees = loadEmployees();
      for(let r=0;r<employees.length;r++){
        const emp = employees[r];
        const tr = ce('tr');

        // שם
        const tdName = ce('td',{className:'name'});
        const nameInput = ce('input',{type:'text', value: emp.name||"", style:"width:100%"});
        nameInput.oninput = ()=>{ emp.name = nameInput.value; autoSave(); };
        tdName.appendChild(nameInput);
        tr.appendChild(tdName);

        // בוקר/ערב לכל יום + שדות שעה
        for(let i=0;i<7;i++){
          const dKey = "d"+i;
          emp.shifts = emp.shifts || {};
          emp.shifts[dKey] = emp.shifts[dKey] || {m:false, e:false, timeM:"", timeE:""};

          // בוקר
          const tdM = ce('td');
          const wrapM = ce('div',{style:"display:flex;gap:6px;align-items:center;justify-content:center"});
          const cbM = ce('input',{type:'checkbox', checked: !!emp.shifts[dKey].m});
          const timeM = ce('input',{type:'text', placeholder:'שעה', value: emp.shifts[dKey].timeM||"", style:"width:70px"});
          cbM.onchange = ()=>{ emp.shifts[dKey].m = cbM.checked; autoSave(); };
          timeM.oninput = ()=>{ emp.shifts[dKey].timeM = timeM.value; autoSave(); };
          wrapM.appendChild(cbM); wrapM.appendChild(timeM); tdM.appendChild(wrapM);
          tr.appendChild(tdM);

          // ערב
          const tdE = ce('td');
          const wrapE = ce('div',{style:"display:flex;gap:6px;align-items:center;justify-content:center"});
          const cbE = ce('input',{type:'checkbox', checked: !!emp.shifts[dKey].e});
          const timeE = ce('input',{type:'text', placeholder:'שעה', value: emp.shifts[dKey].timeE||"", style:"width:70px"});
          cbE.onchange = ()=>{ emp.shifts[dKey].e = cbE.checked; autoSave(); };
          timeE.oninput = ()=>{ emp.shifts[dKey].timeE = timeE.value; autoSave(); };
          wrapE.appendChild(cbE); wrapE.appendChild(timeE); tdE.appendChild(wrapE);
          tr.appendChild(tdE);
        }

        // מחיקה
        const tdDel = ce('td');
        const delBtn = ce('button',{textContent:'מחיקה', className:'ghost'});
        delBtn.onclick = ()=>{
          const list = loadEmployees();
          list.splice(r,1);
          saveEmployees(list);
          renderTable();
        };
        tdDel.appendChild(delBtn);
        tr.appendChild(tdDel);

        tbody.appendChild(tr);
      }
    }

    function addEmployee(){
      const list = loadEmployees();
      list.push({ name:"", shifts: {} });
      saveEmployees(list);
      renderTable();
    }

    let saveTimer;
    function autoSave(){
      clearTimeout(saveTimer);
      saveTimer = setTimeout(()=>{
        const list = tableToModel();
        localStorage.setItem('employees', JSON.stringify(list));
        // אין alert כאן כדי לא להציק בזמן עריכה
      }, 250);
    }

    function tableToModel(){
      const rows = Array.from(qs('#tbody').children);
      const list = [];
      rows.forEach(tr=>{
        const tds = Array.from(tr.children);
        const name = tds[0].querySelector('input').value.trim();
        const emp = { name, shifts:{} };
        for(let i=0;i<7;i++){
          // לכל יום יש 2 תאים (בוקר/ערב) אחרי תא השם => טווח [1..14]
          const tdM = tds[1 + i*2];
          const tdE = tds[1 + i*2 + 1];
          const m = tdM.querySelector('input[type="checkbox"]').checked;
          const timeM = tdM.querySelector('input[type="text"]').value.trim();
          const e = tdE.querySelector('input[type="checkbox"]').checked;
          const timeE = tdE.querySelector('input[type="text"]').value.trim();
          emp.shifts["d"+i] = {m, e, timeM, timeE};
        }
        list.push(emp);
      });
      return list;
    }

    // --- init ---
    function renderDatesInputs(){
      renderDates();
      // חיבור כפתורים
      qs('#btnFillWeek').onclick = ()=>{
        const dates = fillNextWeek();
        localStorage.setItem('weekDates', JSON.stringify(dates));
        renderDates();
      };
      qs('#btnSaveDates').onclick = ()=>{
        const inputs = Array.from(qs('#datesRow').querySelectorAll('input[type="text"]'));
        const dates = inputs.map(i=>i.value.trim());
        saveDates(dates);
      };
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      renderDatesInputs();
      renderTable();
      qs('#btnAdd').onclick = addEmployee;
      qs('#btnSaveAll').onclick = ()=>{
        const list = tableToModel();
        saveEmployees(list);
      };
    });
  </script>
</body>
</html>
